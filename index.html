<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#000000">
<title>To Do</title>
<style>
:root { color-scheme: dark; }
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", sans-serif;
  background: #000;
  color: #fff;
}
header {
  text-align: center;
  padding: 16px;
  background: #1c1c1e;
}
header input {
  width: 240px;
  background: transparent;
  border: none;
  color: #fff;
  font-size: 24px;
  font-weight: 600;
  text-align: center;
}
.monthNav {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 16px;
}
.monthNav button, .small {
  background: #2c2c2e;
  color: #fff;
  border: none;
  border-radius: 12px;
  padding: 8px 10px;
}
.monthNav button:disabled { opacity: 0.4; }
#monthLabel { font-size: 18px; }
.calendar {
  padding: 10px;
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 6px;
}
.weekday {
  text-align: center;
  font-size: 12px;
  color: #8e8e93;
}
.day {
  background: #1c1c1e;
  border-radius: 14px;
  min-height: 78px;
  padding: 6px;
  text-align: center;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  cursor: pointer;
}
.today { border: 2px solid #0a84ff; }
.future { opacity: 0.45; }
.rate { font-size: 17px; }
.fab {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%);
  width: 64px;
  height: 64px;
  border-radius: 32px;
  border: none;
  font-size: 36px;
  background: #0a84ff;
  color: #fff;
}
.overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.62);
  display: none;
  justify-content: center;
  align-items: center;
  padding: 16px;
}
.modal {
  width: min(460px, 100%);
  max-height: 90vh;
  overflow: auto;
  background: #1c1c1e;
  border-radius: 18px;
  padding: 18px;
}
.tabs {
  display: flex;
  gap: 10px;
  margin: 10px 0 14px;
}
.tabs button {
  flex: 1;
  border: none;
  border-radius: 12px;
  padding: 10px;
  color: #fff;
  background: #2c2c2e;
}
.activeTab { background: #0a84ff !important; }
.task {
  display: flex;
  justify-content: space-between;
  gap: 8px;
  align-items: center;
  padding: 8px;
  border-radius: 12px;
  background: #2c2c2e;
  margin-bottom: 8px;
}
.task.done span { text-decoration: line-through; opacity: .45; }
.taskActions { display: flex; gap: 6px; align-items: center; }
.inputRow { display: flex; gap: 8px; margin-top: 10px; }
.inputRow input {
  flex: 1;
  border: none;
  border-radius: 12px;
  background: #2c2c2e;
  color: #fff;
  padding: 10px;
}
</style>
</head>
<body>
<header><input id="appTitle" value="To Do"></header>
<div class="monthNav">
  <button id="prevBtn" onclick="changeMonth(-1)">←</button>
  <div id="monthLabel"></div>
  <button id="nextBtn" onclick="changeMonth(1)">→</button>
</div>
<div class="calendar" id="calendar"></div>
<button class="fab" onclick="openModal()">＋</button>
<div class="overlay" id="overlay" onclick="closeModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <h3 id="modalDate"></h3>
    <div id="rateDisplay"></div>
    <div class="tabs">
      <button id="dailyTab" onclick="switchTab('daily')">デイリー</button>
      <button id="singleTab" onclick="switchTab('single')">非デイリー</button>
    </div>
    <div id="taskList"></div>
    <div class="inputRow">
      <input id="taskInput" placeholder="タスクを入力">
      <button class="small" onclick="addTask()">追加</button>
    </div>
  </div>
</div>
<script>
const STORAGE_KEY = "todoApp_v2";

function formatLocal(d) {
  return d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, "0") + "-" + String(d.getDate()).padStart(2, "0");
}
function createId() {
  if (crypto?.randomUUID) return crypto.randomUUID();
  return "id-" + Date.now().toString(36) + "-" + Math.random().toString(36).slice(2, 10);
}
function emptyDateEntry() {
  return { daily: {}, single: {}, dailyOrder: [], singleOrder: [], dailyExcluded: {} };
}

const today = new Date();
const todayStr = formatLocal(today);
const minMonth = new Date(today.getFullYear(), today.getMonth() - 3, 1);
const maxMonth = new Date(today.getFullYear(), today.getMonth() + 3, 1);
let viewDate = new Date(today.getFullYear(), today.getMonth(), 1);
let selectedDate = todayStr;
let currentTab = "daily";
let dragId = null;

const raw = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
let appData = {
  appTitle: raw.appTitle || "To Do",
  masterDaily: raw.masterDaily && typeof raw.masterDaily === "object" ? raw.masterDaily : {},
  calendar: raw.calendar && typeof raw.calendar === "object" ? raw.calendar : {}
};

function save() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
}

function ensureDate(dateStr) {
  if (!appData.calendar[dateStr]) appData.calendar[dateStr] = emptyDateEntry();
  const day = appData.calendar[dateStr];
  day.daily = day.daily || {};
  day.single = day.single || {};
  day.dailyOrder = Array.isArray(day.dailyOrder) ? day.dailyOrder : Object.keys(day.daily);
  day.singleOrder = Array.isArray(day.singleOrder) ? day.singleOrder : Object.keys(day.single);
  day.dailyExcluded = day.dailyExcluded || {};

  Object.values(appData.masterDaily).forEach((m) => {
    if (!day.daily[m.id] && !day.dailyExcluded[m.id]) {
      day.daily[m.id] = { id: m.id, text: m.text, done: false, type: "daily" };
      day.dailyOrder.push(m.id);
    }
  });

  day.dailyOrder = day.dailyOrder.filter((id) => !!day.daily[id]);
  day.singleOrder = day.singleOrder.filter((id) => !!day.single[id]);
}

function getTasks(dateStr, tab) {
  ensureDate(dateStr);
  const day = appData.calendar[dateStr];
  const map = day[tab];
  const order = day[tab + "Order"];
  return order.map((id) => map[id]).filter(Boolean);
}

function getRate(dateStr) {
  ensureDate(dateStr);
  const day = appData.calendar[dateStr];
  const all = [...Object.values(day.daily), ...Object.values(day.single)];
  if (!all.length) return { percent: 0, mark: "" };
  const done = all.filter((t) => t.done).length;
  const percent = Math.round(done / all.length * 100);
  const mark = percent === 100 ? "✓" : percent >= 60 ? "•" : "×";
  return { percent, mark };
}

function changeMonth(offset) {
  const d = new Date(viewDate.getFullYear(), viewDate.getMonth() + offset, 1);
  if (d < minMonth || d > maxMonth) return;
  viewDate = d;
  renderCalendar();
}

function renderCalendar() {
  const cal = document.getElementById("calendar");
  cal.innerHTML = "";
  const y = viewDate.getFullYear();
  const m = viewDate.getMonth();
  document.getElementById("monthLabel").innerText = `${y}年 ${m + 1}月`;
  const weekdays = ["日", "月", "火", "水", "木", "金", "土"];
  weekdays.forEach((w) => {
    const div = document.createElement("div");
    div.className = "weekday";
    div.innerText = w;
    cal.appendChild(div);
  });

  document.getElementById("prevBtn").disabled = viewDate <= minMonth;
  document.getElementById("nextBtn").disabled = viewDate >= maxMonth;

  const firstDay = new Date(y, m, 1).getDay();
  const days = new Date(y, m + 1, 0).getDate();
  for (let i = 0; i < firstDay; i++) cal.appendChild(document.createElement("div"));

  for (let i = 1; i <= days; i++) {
    const d = new Date(y, m, i);
    const dateStr = formatLocal(d);
    ensureDate(dateStr);
    const div = document.createElement("div");
    div.className = "day";
    if (dateStr === todayStr) div.classList.add("today");
    if (dateStr > todayStr) div.classList.add("future");
    let mark = "";
    if (dateStr <= todayStr) mark = getRate(dateStr).mark;
    div.innerHTML = `<div>${i}</div><div class="rate">${mark}</div>`;
    div.onclick = () => { selectedDate = dateStr; openModal(); };
    cal.appendChild(div);
  }
}

function openModal() {
  ensureDate(selectedDate);
  document.getElementById("modalDate").innerText = selectedDate;
  document.getElementById("overlay").style.display = "flex";
  switchTab(currentTab);
  updateRate();
}
function closeModal() { document.getElementById("overlay").style.display = "none"; }

function switchTab(tab) {
  currentTab = tab;
  document.getElementById("dailyTab").classList.toggle("activeTab", tab === "daily");
  document.getElementById("singleTab").classList.toggle("activeTab", tab === "single");
  renderTasks();
}
function updateRate() {
  const r = getRate(selectedDate);
  document.getElementById("rateDisplay").innerText = `${r.mark}：達成率 ${r.percent}%`;
}

function addTask() {
  ensureDate(selectedDate);
  const input = document.getElementById("taskInput");
  const text = input.value.trim();
  if (!text) return;

  if (currentTab === "daily") {
    const id = createId();
    appData.masterDaily[id] = { id, text, createdAt: selectedDate };
    Object.keys(appData.calendar).forEach((date) => {
      ensureDate(date);
      const day = appData.calendar[date];
      if (!day.dailyExcluded[id]) {
        day.daily[id] = { id, text, done: false, type: "daily" };
        day.dailyOrder.push(id);
      }
    });
  } else {
    const id = createId();
    const day = appData.calendar[selectedDate];
    day.single[id] = { id, text, done: false, type: "single" };
    day.singleOrder.push(id);
  }

  input.value = "";
  save();
  renderTasks();
  renderCalendar();
  updateRate();
}

function editTask(id) {
  ensureDate(selectedDate);
  const day = appData.calendar[selectedDate];
  if (currentTab === "single") {
    const task = day.single[id];
    const nextText = prompt("タスクを編集", task.text);
    if (!nextText || !nextText.trim()) return;
    task.text = nextText.trim();
  } else {
    const task = day.daily[id];
    const nextText = prompt("デイリーを編集", task.text);
    if (!nextText || !nextText.trim()) return;
    const choice = prompt("編集範囲を選択\n1 → すべて変更\n2 → 今日以降のみ変更\n3 → キャンセル");
    if (choice !== "1" && choice !== "2") return;

    appData.masterDaily[id].text = nextText.trim();
    Object.keys(appData.calendar).forEach((date) => {
      if (choice === "1" || date >= todayStr) {
        const d = appData.calendar[date];
        if (d.daily[id]) d.daily[id].text = nextText.trim();
      }
    });
  }
  save();
  renderTasks();
  renderCalendar();
}

function deleteTask(id) {
  ensureDate(selectedDate);
  const day = appData.calendar[selectedDate];

  if (currentTab === "single") {
    delete day.single[id];
    day.singleOrder = day.singleOrder.filter((x) => x !== id);
  } else {
    if (selectedDate < todayStr) {
      alert("過去日のデイリーは削除できません");
      return;
    }
    const choice = prompt("削除方法\n1 → この日だけ削除\n2 → この日以降すべて削除\n3 → キャンセル");
    if (choice === "1") {
      delete day.daily[id];
      day.dailyOrder = day.dailyOrder.filter((x) => x !== id);
      day.dailyExcluded[id] = true;
    } else if (choice === "2") {
      delete appData.masterDaily[id];
      Object.keys(appData.calendar).forEach((date) => {
        if (date >= selectedDate) {
          const d = appData.calendar[date];
          delete d.daily[id];
          d.dailyOrder = d.dailyOrder.filter((x) => x !== id);
          d.dailyExcluded[id] = true;
        }
      });
    } else {
      return;
    }
  }

  save();
  renderTasks();
  renderCalendar();
  updateRate();
}

function reorderByDoneGroup(day, tab, id) {
  const orderKey = tab + "Order";
  const map = day[tab];
  const original = day[orderKey].filter((x) => !!map[x]);
  const todo = original.filter((x) => !map[x].done);
  const done = original.filter((x) => map[x].done);
  const targetGroup = map[id].done ? done : todo;
  const idx = targetGroup.indexOf(id);
  if (idx >= 0) {
    targetGroup.splice(idx, 1);
    targetGroup.push(id);
  }
  day[orderKey] = [...todo, ...done];
}

function toggleTask(id) {
  const day = appData.calendar[selectedDate];
  const task = day[currentTab][id];
  task.done = !task.done;
  reorderByDoneGroup(day, currentTab, id);
  save();
  renderTasks();
  renderCalendar();
  updateRate();
}

function renderTasks() {
  ensureDate(selectedDate);
  const list = document.getElementById("taskList");
  list.innerHTML = "";
  const day = appData.calendar[selectedDate];
  const map = day[currentTab];
  const orderKey = currentTab + "Order";

  day[orderKey].filter((id) => map[id]).forEach((id) => {
    const t = map[id];
    const div = document.createElement("div");
    div.className = "task" + (t.done ? " done" : "");
    div.draggable = true;
    div.ondragstart = () => { dragId = id; };
    div.ondragover = (e) => {
      if (dragId && map[dragId] && map[dragId].done === t.done) e.preventDefault();
    };
    div.ondrop = () => {
      if (!dragId || dragId === id || !map[dragId] || map[dragId].done !== t.done) return;
      const order = day[orderKey];
      const from = order.indexOf(dragId);
      const to = order.indexOf(id);
      order.splice(from, 1);
      order.splice(to, 0, dragId);
      save();
      renderTasks();
    };
    div.innerHTML = `<span>${t.text}</span>
      <div class="taskActions">
        <input type="checkbox" ${t.done ? "checked" : ""}>
        <button class="small">編集</button>
        <button class="small">削除</button>
      </div>`;
    div.querySelector("input").onchange = () => toggleTask(id);
    div.querySelectorAll("button")[0].onclick = () => editTask(id);
    div.querySelectorAll("button")[1].onclick = () => deleteTask(id);
    list.appendChild(div);
  });
}

document.getElementById("appTitle").value = appData.appTitle;
document.getElementById("appTitle").onchange = (e) => {
  appData.appTitle = e.target.value || "To Do";
  save();
};

renderCalendar();
</script>
</body>
</html>
