<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#000000">

<title>To Do</title>

<style>
body{
  margin:0;
  font-family:sans-serif;
  background:#f5f5f5;
  color:#111;
}

/* ---------- HEADER ---------- */

header{
  text-align:center;
  padding:15px;
  font-size:22px;
  font-weight:bold;
  background:#fff;
}

header input{
  border:none;
  font-size:22px;
  font-weight:bold;
  text-align:center;
  background:transparent;
  width:200px;
}

/* ---------- CALENDAR ---------- */

.calendar{
  padding:10px;
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:6px;
}

.day{
  background:#fff;
  border-radius:12px;
  min-height:70px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:space-between;
  padding:6px;
  font-size:12px;
}

.day:hover{
  background:#eaeaea;
}

.today{
  border:2px solid #000;
}

.rate{
  font-size:18px;
}

/* ---------- FLOAT BUTTON ---------- */

.fab{
  position:fixed;
  bottom:30px;
  left:50%;
  transform:translateX(-50%);
  width:70px;
  height:70px;
  border-radius:50%;
  background:#000;
  color:#fff;
  font-size:40px;
  border:none;
}

/* ---------- MODAL ---------- */

.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.4);
  display:none;
  justify-content:center;
  align-items:center;
}

.modal{
  background:#fff;
  width:90%;
  max-width:400px;
  border-radius:20px;
  padding:20px;
}

.task{
  display:flex;
  justify-content:space-between;
  padding:6px 0;
}

.done{
  text-decoration:line-through;
  opacity:0.5;
}

button.small{
  background:#000;
  color:#fff;
  border:none;
  border-radius:6px;
  padding:4px 6px;
  font-size:12px;
}
</style>
</head>
<body>

<header>
  <input id="appTitle" value="To Do">
</header>

<div class="calendar" id="calendar"></div>

<button class="fab" onclick="openModal()">＋</button>

<div class="overlay" id="overlay" onclick="closeModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <h3 id="modalDate"></h3>
    <div id="taskList"></div>
    <input id="taskInput" placeholder="タスクを入力">
    <button class="small" onclick="addTask()">追加</button>
  </div>
</div>

<script>
function format(d){
 return d.toISOString().split("T")[0];
}

let today=format(new Date());
let selectedDate=today;

let data=JSON.parse(localStorage.getItem("todoData")||"{}");

function save(){
 localStorage.setItem("todoData",JSON.stringify(data));
 localStorage.setItem("appTitle",
  document.getElementById("appTitle").value);
}

document.getElementById("appTitle").value=
 localStorage.getItem("appTitle")||"To Do";

document.getElementById("appTitle").onchange=save;

function ensure(date){
 if(!data[date]) data[date]=[];
}

function renderCalendar(){
 const cal=document.getElementById("calendar");
 cal.innerHTML="";
 let now=new Date();
 let y=now.getFullYear();
 let m=now.getMonth();
 let days=new Date(y,m+1,0).getDate();

 for(let i=1;i<=days;i++){
  let d=new Date(y,m,i);
  let date=format(d);
  ensure(date);

  let div=document.createElement("div");
  div.className="day";
  if(date===today) div.classList.add("today");

  let done=data[date].filter(t=>t.done).length;
  let total=data[date].length;
  let mark="";
  if(total>0){
    let p=done/total;
    if(p===1) mark="✓";
    else if(p>=0.5) mark="•";
    else mark="×";
  }

  div.innerHTML=`<div>${i}</div><div class="rate">${mark}</div>`;
  div.onclick=()=>{selectedDate=date;openModal();};
  cal.appendChild(div);
 }
}

function openModal(){
 ensure(selectedDate);
 document.getElementById("modalDate").innerText=selectedDate;
 document.getElementById("overlay").style.display="flex";
 renderTasks();
}

function closeModal(){
 document.getElementById("overlay").style.display="none";
}

function addTask(){
 let input=document.getElementById("taskInput");
 if(!input.value) return;

 data[selectedDate].push({text:input.value,done:false});
 input.value="";
 save();
 renderTasks();
 renderCalendar();
}

function toggle(i){
 data[selectedDate][i].done=
 !data[selectedDate][i].done;
 save();
 renderTasks();
 renderCalendar();
}

function renderTasks(){
 let list=document.getElementById("taskList");
 list.innerHTML="";
 data[selectedDate].forEach((t,i)=>{
  let div=document.createElement("div");
  div.className="task";
  if(t.done) div.classList.add("done");
  div.innerHTML=`
    <span>${t.text}</span>
    <input type="checkbox"
      ${t.done?"checked":""}
      onchange="toggle(${i})">
  `;
  list.appendChild(div);
 });
}

renderCalendar();
</script>

</body>
</html>
